--[[
    LitClient FE | v1.0.3 (Compact / Mobile Friendly)
    Style: Infinite Yield (Sleek, Bottom Right, Locked Position)
]]

local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local CoreGui = game:GetService("CoreGui")
local LocalPlayer = Players.LocalPlayer

--// CONFIG
local Config = {
    Color = Color3.fromRGB(50, 50, 50), -- Dark Grey (IY Style)
    Accent = Color3.fromRGB(255, 255, 255), -- White Text
    Prefix = ";",
    Speed = 0.3 -- Animation speed
}

--// FLIGHT HANDLERS (New Robust Implementation)
local Flying = false
local CurrentFlySpeed = Config.DefaultFlySpeed
local MovementVector = Vector3.new(0, 0, 0)
local ControlState = {W=false, S=false, A=false, D=false, E=false, Q=false} -- Track WASD QE

local function UpdateMovementVector(input)
    local key = input.KeyCode.Name
    local isDown = input.UserInputState == Enum.UserInputState.Begin
    
    if key == "W" then ControlState.W = isDown
    elseif key == "S" then ControlState.S = isDown
    elseif key == "A" then ControlState.A = isDown
    elseif key == "D" then ControlState.D = isDown
    -- Add vertical controls for better mobile use
    elseif key == "E" then ControlState.E = isDown -- Up
    elseif key == "Q" then ControlState.Q = isDown -- Down
    end
end

local function CalculateVelocity()
    local root = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
    local camera = workspace.CurrentCamera
    if not root or not camera then return end

    local camCF = camera.CFrame
    local x, y, z = 0, 0, 0

    if ControlState.W then z = -1 -- Forward
    elseif ControlState.S then z = 1 -- Backward
    end
    if ControlState.A then x = -1 -- Left
    elseif ControlState.D then x = 1 -- Right
    end
    
    -- Calculate movement relative to the camera, ignoring Y component for horizontal movement
    local horizontalMovement = camCF.LookVector * z + camCF.RightVector * x
    horizontalMovement = Vector3.new(horizontalMovement.X, 0, horizontalMovement.Z)
    
    -- Vertical movement
    local verticalMovement = (ControlState.E and 1 or 0) + (ControlState.Q and -1 or 0)
    
    local finalVelocity = (horizontalMovement * CurrentFlySpeed) + Vector3.new(0, verticalMovement * CurrentFlySpeed, 0)
    
    -- Smooth acceleration/deceleration if no input is pressed
    if finalVelocity.Magnitude < 0.1 and root:FindFirstChild("FlyBV") then
         root.FlyBV.Velocity = root.FlyBV.Velocity * 0.9 -- Decelerate
    else
         return finalVelocity
    end
end

local function FlyLoop(dt)
    if not Flying then return end

    local root = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
    local humanoid = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid")
    
    if not root or not humanoid then return end
    
    -- Keep player looking in camera direction
    root.FlyBG.CFrame = workspace.CurrentCamera.CFrame
    
    -- Calculate and apply velocity
    root.FlyBV.Velocity = CalculateVelocity() or Vector3.new(0,0,0)
end

local function StartFly(speed)
    if Flying then return end
    
    local root = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
    local humanoid = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid")

    if not root or not humanoid then return end

    -- Set Speed
    CurrentFlySpeed = tonumber(speed) or Config.DefaultFlySpeed

    -- Setup Body Movers
    local bg = Instance.new("BodyGyro", root)
    bg.Name = "FlyBG"
    bg.MaxTorque = Vector3.new(9e9, 9e9, 9e9)
    bg.CFrame = root.CFrame
    
    local bv = Instance.new("BodyVelocity", root)
    bv.Name = "FlyBV"
    bv.MaxForce = Vector3.new(9e9, 9e9, 9e9)
    bv.Velocity = Vector3.new(0, 0.1, 0) -- Tiny upward velocity to counter gravity

    -- Essential settings
    humanoid.PlatformStand = true
    Flying = true
    game:GetService("StarterGui"):SetCore("SendNotification", {Title="LitClient", Text="Flight Enabled. Speed: " .. CurrentFlySpeed .. ". (W/A/S/D to move, Q/E for vertical)"})
    
    -- Bind loop
    RunService:BindToRenderStep("LitClientFly", Enum.RenderPriority.Camera.Value + 1, FlyLoop)
    
    -- Listen to input for continuous movement
    UserInputService.InputBegan:Connect(UpdateMovementVector)
    UserInputService.InputEnded:Connect(UpdateMovementVector)
end

local function StopFly()
    if not Flying then return end
    
    local root = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
    local humanoid = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid")

    if root then
        if root:FindFirstChild("FlyBG") then root.FlyBG:Destroy() end
        if root:FindFirstChild("FlyBV") then root.FlyBV:Destroy() end
    end

    if humanoid then humanoid.PlatformStand = false end
    
    -- Reset state
    Flying = false
    ControlState = {W=false, S=false, A=false, D=false, E=false, Q=false}
    RunService:UnbindFromRenderStep("LitClientFly")
    game:GetService("StarterGui"):SetCore("SendNotification", {Title="LitClient", Text="Flight Disabled."})
end

--// COMMAND TABLE (Edit Here)
local Commands = {
    {
        Name = "fly", 
        Desc = "Toggle flight mode, optional speed (e.g., fly 150)", 
        Func = function(args) 
            if Flying then StopFly() else StartFly(args[1]) end
        end
    },
    {
        Name = "unfly",
        Desc = "Stops flight mode",
        Func = StopFly
    },
    {
        Name = "speed", 
        Desc = "Set walkspeed (e.g. speed 100)", 
        Func = function(args)
            if LocalPlayer.Character and args[1] then
                LocalPlayer.Character.Humanoid.WalkSpeed = tonumber(args[1]) or 16
            end
        end
    },
    {
        Name = "jump", 
        Desc = "Set jumppower (e.g. jump 50)", 
        Func = function(args)
            if LocalPlayer.Character and args[1] then
                LocalPlayer.Character.Humanoid.JumpPower = tonumber(args[1]) or 50
            end
        end
    },
    {
        Name = "esp",
        Desc = "Highlight all players",
        Func = function()
            for _, p in pairs(Players:GetPlayers()) do
                if p ~= LocalPlayer and p.Character then
                    local h = Instance.new("Highlight", p.Character)
                    h.FillColor = Color3.fromRGB(255,0,0)
                    h.OutlineColor = Color3.fromRGB(255, 255, 255)
                end
            end
        end
    },
    {
        Name = "rejoin",
        Desc = "Rejoins the server",
        Func = function()
            game:GetService("TeleportService"):Teleport(game.PlaceId, LocalPlayer)
        end
    }
}

--// UI CONSTRUCTION
local LitGUI = Instance.new("ScreenGui")
LitGUI.Name = "LitClientFE"
LitGUI.Parent = CoreGui
LitGUI.ResetOnSpawn = false

-- 1. Main Bar (Bottom Right)
local MainBar = Instance.new("Frame")
MainBar.Name = "MainBar"
MainBar.Parent = LitGUI
MainBar.BackgroundColor3 = Config.Color
MainBar.BackgroundTransparency = 0.1
MainBar.Position = UDim2.new(1, -260, 1, -50) -- Locked Bottom Right Corner
MainBar.Size = UDim2.new(0, 250, 0, 35)
MainBar.BorderSizePixel = 0
MainBar.Active = true
MainBar.Draggable = false -- HARDCODED: No longer draggable!

local Corner = Instance.new("UICorner")
Corner.CornerRadius = UDim.new(0, 6)
Corner.Parent = MainBar

-- Input Box
local Input = Instance.new("TextBox")
Input.Parent = MainBar
Input.BackgroundTransparency = 1
Input.Position = UDim2.new(0, 10, 0, 0)
Input.Size = UDim2.new(1, -40, 1, 0)
Input.Font = Enum.Font.GothamBold
Input.PlaceholderText = "Command Bar (;)"
Input.Text = ""
Input.TextColor3 = Config.Accent
Input.PlaceholderColor3 = Color3.fromRGB(150, 150, 150)
Input.TextSize = 14
Input.TextXAlignment = Enum.TextXAlignment.Left

-- Toggle Button (For the list)
local ListToggle = Instance.new("TextButton")
ListToggle.Parent = MainBar
ListToggle.BackgroundTransparency = 1
ListToggle.Position = UDim2.new(1, -30, 0, 0)
ListToggle.Size = UDim2.new(0, 30, 1, 0)
ListToggle.Font = Enum.Font.GothamBold
ListToggle.Text = "+"
ListToggle.TextColor3 = Config.Accent
ListToggle.TextSize = 18

-- 2. Command List (Hidden by default, pops up above bar)
local ListFrame = Instance.new("Frame")
ListFrame.Name = "ListFrame"
ListFrame.Parent = MainBar
ListFrame.BackgroundColor3 = Config.Color
ListFrame.BackgroundTransparency = 0.1
ListFrame.Position = UDim2.new(0, 0, 0, 0) -- Starts closed
ListFrame.Size = UDim2.new(1, 0, 0, 0) -- Height 0
ListFrame.ClipsDescendants = true
ListFrame.BorderSizePixel = 0
ListFrame.ZIndex = 0

local ListCorner = Instance.new("UICorner")
ListCorner.CornerRadius = UDim.new(0, 6)
ListCorner.Parent = ListFrame

local Scroller = Instance.new("ScrollingFrame")
Scroller.Parent = ListFrame
Scroller.BackgroundTransparency = 1
Scroller.Position = UDim2.new(0, 5, 0, 5)
Scroller.Size = UDim2.new(1, -10, 1, -10)
Scroller.CanvasSize = UDim2.new(0, 0, 0, 0)
Scroller.ScrollBarThickness = 2

local UIList = Instance.new("UIListLayout")
UIList.Parent = Scroller
UIList.SortOrder = Enum.SortOrder.LayoutOrder

--// FUNCTIONS
local ListOpen = false

local function ToggleList()
    ListOpen = not ListOpen
    local targetSize = ListOpen and UDim2.new(1, 0, 0, 200) or UDim2.new(1, 0, 0, 0)
    local targetPos = ListOpen and UDim2.new(0, 0, 1, -240) or UDim2.new(0, 0, 0, 0) -- Slide UP
    
    ListToggle.Text = ListOpen and " ^" or "+" -- Update button text for clarity

    TweenService:Create(ListFrame, TweenInfo.new(Config.Speed, Enum.EasingStyle.Quart), {
        Size = targetSize,
        Position = targetPos
    }):Play()
end

local function PopulateList()
    -- Clear old
    for _, v in pairs(Scroller:GetChildren()) do
        if v:IsA("TextLabel") then v:Destroy() end
    end
    
    local ySize = 0
    for i, cmd in pairs(Commands) do
        local lbl = Instance.new("TextLabel")
        lbl.Parent = Scroller
        lbl.BackgroundTransparency = 1
        lbl.Size = UDim2.new(1, 0, 0, 25)
        lbl.Font = Enum.Font.Gotham
        lbl.TextColor3 = Config.Accent
        lbl.TextXAlignment = Enum.TextXAlignment.Left
        lbl.Text = Config.Prefix .. cmd.Name .. " - " .. cmd.Desc
        lbl.TextSize = 12
        ySize = ySize + 25
    end
    Scroller.CanvasSize = UDim2.new(0, 0, 0, ySize)
end

local function Execute(text)
    local args = text:split(" ")
    local cmdName = table.remove(args, 1):lower()
    
    if string.sub(cmdName, 1, 1) == Config.Prefix then
        cmdName = string.sub(cmdName, 2)
    end

    local found = false
    for _, cmd in pairs(Commands) do
        if cmd.Name:lower() == cmdName then
            cmd.Func(args)
            found = true
            -- Visual Feedback
            Input.PlaceholderText = "Executed: " .. cmdName
            wait(1)
            Input.PlaceholderText = "Command Bar (;) â€¢ LitClient FE (v1.0.3)"
            break
        end
    end
    
    if not found then
        Input.PlaceholderText = "Invalid Command"
        wait(1)
        Input.PlaceholderText = "Command Bar"
    end
end

--// EVENTS
ListToggle.MouseButton1Click:Connect(ToggleList)

Input.FocusLost:Connect(function(enter)
    if enter and Input.Text ~= "" then
        Execute(Input.Text)
        Input.Text = ""
    end
end)

-- Initialize List
PopulateList()

game:GetService("StarterGui"):SetCore("SendNotification", {
    Title = "LitClient FE";
    Text = "Loaded!";
    Duration = 0.7;
})
