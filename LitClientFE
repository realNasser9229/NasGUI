--[[
    LitClient FE | v1.0.3 (Compact / Mobile Friendly)
    Style: Infinite Yield (Sleek, Bottom Right, Locked Position)
]]

local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local CoreGui = game:GetService("CoreGui")
local LocalPlayer = Players.LocalPlayer

--// CONFIG
local Config = {
    Color = Color3.fromRGB(50, 50, 50), -- Dark Grey (IY Style)
    Accent = Color3.fromRGB(255, 255, 255), -- White Text
    Prefix = ";",
    Speed = 0.3 -- Animation speed
}

-- ==============================
-- LitClient FE — Joystick-friendly Fly
-- Uses Humanoid.MoveDirection + Camera pitch + JumpRequest
-- ==============================

local LocalPlayer = Players.LocalPlayer
local FlyActive = false
local FlySpeed = 50                      -- studs/second (default)
local PitchInfluence = 0.9               -- how much camera pitch affects vertical movement (0..1)
local JumpBoost = 60                     -- immediate upward boost when jump pressed
local JumpBoostDecay = 6                 -- how quickly jump boost reduces (per second)
local GravCompensation = 0               -- small upward nudges to avoid falling through small holes

-- internal state
local _bindName = "LitClientFlyRender"
local activeJumpBoost = 0

-- Start flying (speed in studs/sec or nil to use default)
local function StartFly(speed)
    if FlyActive then return end
    FlyActive = true
    FlySpeed = tonumber(speed) or FlySpeed

    local char = LocalPlayer.Character
    if not char then
        FlyActive = false
        return
    end
    local hum = char:FindFirstChildWhichIsA("Humanoid")
    local hrp = char:FindFirstChild("HumanoidRootPart")
    if not hum or not hrp then
        FlyActive = false
        return
    end

    -- Put character in PlatformStand so animations/physics won't fight our movement
    hum.PlatformStand = true

    -- Jump request -> apply an upward boost for a short time
    local jumpConn
    jumpConn = UserInputService.JumpRequest:Connect(function()
        if not FlyActive then return end
        activeJumpBoost = math.max(activeJumpBoost, JumpBoost)
    end)

    -- Render loop: move HRP using MoveDirection + camera pitch + jump boost
    RunService:BindToRenderStep(_bindName, Enum.RenderPriority.Character.Value, function(dt)
        if not FlyActive then return end
        local c = LocalPlayer.Character
        if not c then
            -- safety cleanup
            pcall(function() RunService:UnbindFromRenderStep(_bindName) end)
            if jumpConn then jumpConn:Disconnect() end
            FlyActive = false
            return
        end

        local humanoid = c:FindFirstChildWhichIsA("Humanoid")
        local hrp2 = c:FindFirstChild("HumanoidRootPart")
        local camera = workspace.CurrentCamera
        if not humanoid or not hrp2 or not camera then return end

        -- Movement from joystick / WASD (already world-space)
        local moveDir = humanoid.MoveDirection -- world-space direction (x,z)
        local moveMag = moveDir.Magnitude

        -- Determine how much forward/back aligns with camera LookVector (so looking up while moving forward ascends)
        local camLook = camera.CFrame.LookVector
        local forwardDot = 0
        if moveMag > 0 then
            forwardDot = math.clamp(moveDir.Unit:Dot(Vector3.new(camLook.X, 0, camLook.Z).Unit or Vector3.new(0,0,0)), -1, 1)
        end

        -- camera pitch contribution (range -1..1). positive when looking up.
        local pitchY = camLook.Y -- -1..1

        -- Vertical from camera pitch only when moving (stronger when moving forward / backward)
        local pitchVertical = pitchY * forwardDot * PitchInfluence * FlySpeed

        -- Apply jump boost (decays over time)
        local vb = 0
        if activeJumpBoost > 0 then
            vb = activeJumpBoost
            activeJumpBoost = math.max(0, activeJumpBoost - (JumpBoostDecay * dt))
        end

        -- Combine horizontal movement with vertical components
        -- moveDir already contains no vertical component (Humanoid.MoveDirection is horizontal)
        local horizontal = moveDir * FlySpeed * dt
        local vertical = (pitchVertical + vb + GravCompensation) * dt

        -- Final translation
        local newCFrame = hrp2.CFrame + horizontal + Vector3.new(0, vertical, 0)

        -- Smooth teleport using CFrame to avoid physics explosions; this is local-only
        hrp2.CFrame = newCFrame
    end)

    -- store jump connection so we can disconnect on stop
    StartFly._jumpConn = jumpConn

    -- notify
    pcall(function()
        game:GetService("StarterGui"):SetCore("SendNotification", {
            Title = "LitClient",
            Text = "Flight enabled. Speed: ".. tostring(FlySpeed),
            Duration = 2
        })
    end)
end

local function StopFly()
    if not FlyActive then return end
    FlyActive = false

    -- unbind render loop
    pcall(function() RunService:UnbindFromRenderStep(_bindName) end)

    -- disconnect jump conn if present
    if StartFly._jumpConn then
        pcall(function() StartFly._jumpConn:Disconnect() end)
        StartFly._jumpConn = nil
    end

    -- restore platformstand
    local char = LocalPlayer.Character
    if char then
        local hum = char:FindFirstChildWhichIsA("Humanoid")
        if hum then hum.PlatformStand = false end
    end

    -- notify
    pcall(function()
        game:GetService("StarterGui"):SetCore("SendNotification", {
            Title = "LitClient",
            Text = "Flight disabled.",
            Duration = 1
        })
    end)
end

-- expose StartFly/StopFly (if you integrate into commands table, call StartFly(args[1]) / StopFly())
-- Example commands (replace your existing fly/unfly command functions):
-- Commands entry:
-- { Name = "fly", Func = function(args) if FlyActive then StopFly() else StartFly(args[1]) end end }
-- { Name = "unfly", Func = StopFly }

-- End of fly module

--// COMMAND TABLE (Edit Here)
local Commands = {
    {
        Name = "fly", 
        Desc = "Toggle flight mode, optional speed (e.g., fly 150)", 
        Func = function(args) 
            if Flying then StopFly() else StartFly(args[1]) end
        end
    },
    {
        Name = "unfly",
        Desc = "Stops flight mode immediately",
        Func = StopFly
    },
    {
        Name = "speed", 
        Desc = "Set walkspeed (e.g. speed 100)", 
        Func = function(args)
            if LocalPlayer.Character and args[1] then
                LocalPlayer.Character.Humanoid.WalkSpeed = tonumber(args[1]) or 16
            end
        end
    },
    {
        Name = "jump", 
        Desc = "Set jumppower (e.g. jump 50)", 
        Func = function(args)
            if LocalPlayer.Character and args[1] then
                LocalPlayer.Character.Humanoid.JumpPower = tonumber(args[1]) or 50
            end
        end
    },
    {
        Name = "esp",
        Desc = "Highlight all players",
        Func = function()
            for _, p in pairs(Players:GetPlayers()) do
                if p ~= LocalPlayer and p.Character then
                    local h = Instance.new("Highlight", p.Character)
                    h.FillColor = Color3.fromRGB(255,0,0)
                    h.OutlineColor = Color3.fromRGB(255, 255, 255)
                end
            end
        end
    },
    {
        Name = "rejoin",
        Desc = "Rejoins the server",
        Func = function()
            game:GetService("TeleportService"):Teleport(game.PlaceId, LocalPlayer)
        end
    }
}

--// UI CONSTRUCTION
local LitGUI = Instance.new("ScreenGui")
LitGUI.Name = "LitClientFE"
LitGUI.Parent = CoreGui
LitGUI.ResetOnSpawn = false

-- 1. Main Bar (Bottom Right)
local MainBar = Instance.new("Frame")
MainBar.Name = "MainBar"
MainBar.Parent = LitGUI
MainBar.BackgroundColor3 = Config.Color
MainBar.BackgroundTransparency = 0.1
MainBar.Position = UDim2.new(1, -260, 1, -50) -- Locked Bottom Right Corner
MainBar.Size = UDim2.new(0, 250, 0, 35)
MainBar.BorderSizePixel = 0
MainBar.Active = true
MainBar.Draggable = false -- HARDCODED: No longer draggable!

local Corner = Instance.new("UICorner")
Corner.CornerRadius = UDim.new(0, 6)
Corner.Parent = MainBar

-- Input Box
local Input = Instance.new("TextBox")
Input.Parent = MainBar
Input.BackgroundTransparency = 1
Input.Position = UDim2.new(0, 10, 0, 0)
Input.Size = UDim2.new(1, -40, 1, 0)
Input.Font = Enum.Font.GothamBold
Input.PlaceholderText = "Command Bar (;)"
Input.Text = ""
Input.TextColor3 = Config.Accent
Input.PlaceholderColor3 = Color3.fromRGB(150, 150, 150)
Input.TextSize = 14
Input.TextXAlignment = Enum.TextXAlignment.Left

-- Toggle Button (For the list)
local ListToggle = Instance.new("TextButton")
ListToggle.Parent = MainBar
ListToggle.BackgroundTransparency = 1
ListToggle.Position = UDim2.new(1, -30, 0, 0)
ListToggle.Size = UDim2.new(0, 30, 1, 0)
ListToggle.Font = Enum.Font.GothamBold
ListToggle.Text = "+"
ListToggle.TextColor3 = Config.Accent
ListToggle.TextSize = 18

-- 2. Command List (Hidden by default, pops up above bar)
local ListFrame = Instance.new("Frame")
ListFrame.Name = "ListFrame"
ListFrame.Parent = MainBar
ListFrame.BackgroundColor3 = Config.Color
ListFrame.BackgroundTransparency = 0.1
ListFrame.Position = UDim2.new(0, 0, 0, 0) -- Starts closed
ListFrame.Size = UDim2.new(1, 0, 0, 0) -- Height 0
ListFrame.ClipsDescendants = true
ListFrame.BorderSizePixel = 0
ListFrame.ZIndex = 0

local ListCorner = Instance.new("UICorner")
ListCorner.CornerRadius = UDim.new(0, 6)
ListCorner.Parent = ListFrame

local Scroller = Instance.new("ScrollingFrame")
Scroller.Parent = ListFrame
Scroller.BackgroundTransparency = 1
Scroller.Position = UDim2.new(0, 5, 0, 5)
Scroller.Size = UDim2.new(1, -10, 1, -10)
Scroller.CanvasSize = UDim2.new(0, 0, 0, 0)
Scroller.ScrollBarThickness = 2

local UIList = Instance.new("UIListLayout")
UIList.Parent = Scroller
UIList.SortOrder = Enum.SortOrder.LayoutOrder

--// FUNCTIONS
local ListOpen = false

local function ToggleList()
    ListOpen = not ListOpen
    local targetSize = ListOpen and UDim2.new(1, 0, 0, 200) or UDim2.new(1, 0, 0, 0)
    local targetPos = ListOpen and UDim2.new(0, 0, 1, -240) or UDim2.new(0, 0, 0, 0) -- Slide UP
    
    ListToggle.Text = ListOpen and " ^" or "+" -- Update button text for clarity

    TweenService:Create(ListFrame, TweenInfo.new(Config.Speed, Enum.EasingStyle.Quart), {
        Size = targetSize,
        Position = targetPos
    }):Play()
end

local function PopulateList()
    -- Clear old
    for _, v in pairs(Scroller:GetChildren()) do
        if v:IsA("TextLabel") then v:Destroy() end
    end
    
    local ySize = 0
    for i, cmd in pairs(Commands) do
        local lbl = Instance.new("TextLabel")
        lbl.Parent = Scroller
        lbl.BackgroundTransparency = 1
        lbl.Size = UDim2.new(1, 0, 0, 25)
        lbl.Font = Enum.Font.Gotham
        lbl.TextColor3 = Config.Accent
        lbl.TextXAlignment = Enum.TextXAlignment.Left
        lbl.Text = Config.Prefix .. cmd.Name .. " - " .. cmd.Desc
        lbl.TextSize = 12
        ySize = ySize + 25
    end
    Scroller.CanvasSize = UDim2.new(0, 0, 0, ySize)
end

local function Execute(text)
    local args = text:split(" ")
    local cmdName = table.remove(args, 1):lower()
    
    if string.sub(cmdName, 1, 1) == Config.Prefix then
        cmdName = string.sub(cmdName, 2)
    end

    local found = false
    for _, cmd in pairs(Commands) do
        if cmd.Name:lower() == cmdName then
            cmd.Func(args)
            found = true
            -- Visual Feedback
            Input.PlaceholderText = "Executed: " .. cmdName
            wait(1)
            Input.PlaceholderText = "Command Bar (;) • LitClient FE (v1.0.3)"
            break
        end
    end
    
    if not found then
        Input.PlaceholderText = "Invalid Command"
        wait(1)
        Input.PlaceholderText = "Command Bar"
    end
end

--// EVENTS
ListToggle.MouseButton1Click:Connect(ToggleList)

Input.FocusLost:Connect(function(enter)
    if enter and Input.Text ~= "" then
        Execute(Input.Text)
        Input.Text = ""
    end
end)

-- Initialize List
PopulateList()

game:GetService("StarterGui"):SetCore("SendNotification", {
    Title = "LitClient FE";
    Text = "Loaded!";
    Duration = 0.7;
})
